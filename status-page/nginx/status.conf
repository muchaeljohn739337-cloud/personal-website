# Advancia Status Page - Nginx Configuration
# Copy to: /etc/nginx/sites-available/status.conf
# Enable with: sudo ln -s /etc/nginx/sites-available/status.conf /etc/nginx/sites-enabled/

server {
    listen 80;
    server_name status.advanciapayledger.com;

    # Access logs
    access_log /var/log/nginx/status-access.log;
    error_log /var/log/nginx/status-error.log;

    # Status page UI (public)
    location /status {
        alias /var/www/advancia-status/public;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # Enable caching for static assets
        location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
            expires 1h;
            add_header Cache-Control "public, immutable";
        }
    }

    # Status data endpoint (public read-only)
    location /status/data {
        alias /var/www/advancia-status/logs;
        
        # Allow reading status.json and metrics.json
        location ~ ^/status/data/(status|metrics)\.json$ {
            add_header Content-Type application/json;
            add_header Access-Control-Allow-Origin *;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # Block other files
        location ~ ^/status/data/ {
            return 403;
        }
    }

    # Logs endpoint (requires authentication)
    location /status/logs {
        auth_basic "Restricted Access - Admin Only";
        auth_basic_user_file /etc/nginx/.htpasswd;
        
        alias /var/www/advancia-status/logs;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        
        # Allow JSON log files
        location ~ \.json$ {
            add_header Content-Type application/json;
        }
        
        # Allow text logs
        location ~ \.log$ {
            add_header Content-Type text/plain;
        }
    }

    # Incidents API endpoint (public read-only)
    location /status/incidents {
        alias /var/www/advancia-status/logs/incidents.json;
        add_header Content-Type application/json;
        add_header Access-Control-Allow-Origin *;
        add_header Cache-Control "no-cache";
    }

    # Health check endpoint
    location /status/health {
        return 200 '{"status":"ok","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # Redirect root to status page
    location = / {
        return 301 /status;
    }

    # Block access to hidden files
    location ~ /\. {
        deny all;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # SSL configuration (uncomment after running certbot)
    # listen 443 ssl http2;
    # ssl_certificate /etc/letsencrypt/live/status.advanciapayledger.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/status.advanciapayledger.com/privkey.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;
    # ssl_prefer_server_ciphers on;
}

# Redirect HTTP to HTTPS (enable after SSL setup)
# server {
#     listen 80;
#     server_name status.advanciapayledger.com;
#     return 301 https://$server_name$request_uri;
# }
