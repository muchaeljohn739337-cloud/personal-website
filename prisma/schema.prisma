// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER & AUTHENTICATION
// =============================================================================

model User {
  id               String    @id @default(cuid())
  name             String?
  email            String    @unique
  emailVerified    DateTime? @map("email_verified")
  image            String?
  password         String?
  role             UserRole  @default(USER)
  phone            String?
  twoFactorEnabled Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?   @map("two_factor_secret")
  backupCodes      String[]  @default([]) @map("backup_codes")

  // Stripe
  stripeCustomerId String? @unique @map("stripe_customer_id")

  // Referral
  referralCode String? @unique @map("referral_code")
  referredBy   String? @map("referred_by")

  // Relations
  accounts            Account[]
  sessions            Session[]
  posts               Post[]
  passwordResetTokens PasswordResetToken[]

  // Organization relations
  ownedOrganizations Organization[]       @relation("OrganizationOwner")
  memberships        OrganizationMember[]
  sentInvitations    Invitation[]         @relation("InvitationSender")

  // Activity & Audit
  activityLogs  ActivityLog[]
  notifications Notification[]

  // Fintech relations
  wallets              Wallet[]
  sentTransactions     Transaction[] @relation("TransactionSender")
  receivedTransactions Transaction[] @relation("TransactionReceiver")

  // Token & Rewards (Advancia)
  tokenWallet        TokenWallet?
  userRewards        UserRewards?
  leaderboardEntries Leaderboard[]

  // Health (MedBed)
  healthProfile HealthProfile?

  // Referrals
  referralsMade     Referral[] @relation("ReferralsMade")
  referralsReceived Referral[] @relation("ReferralsReceived")

  // Debit Cards
  debitCards DebitCard[]

  // Crypto Payments
  cryptoPayments    CryptoPayment[]
  cryptoWithdrawals CryptoWithdrawal[]

  // MedBed
  medBedBookings MedBedBooking[]
  medBedSessions MedBedSession[]
  medBedStaff    MedBedStaff[]

  // Admin & Management
  adminActions     AdminAction[]    @relation("AdminActions")
  actionsReceived  AdminAction[]    @relation("UserActions")
  suspensions      UserSuspension[]
  suspensionsGiven UserSuspension[] @relation("SuspensionsByAdmin")
  emailLogs        EmailLog[]
  fileUploads      FileUpload[]
  auditLogs        AuditLog[]

  // Blog
  blogPosts BlogPost[] @relation("BlogPostAuthor")

  // CRM
  crmContacts   CrmContact[]  @relation("ContactOwner")
  crmDeals      CrmDeal[]     @relation("DealOwner")
  crmNotes      CrmNote[]     @relation("NoteAuthor")
  crmActivities CrmActivity[] @relation("ActivityOwner")
  crmEmails     CrmEmail[]    @relation("EmailSender")

  // Password Manager
  passwordEntries PasswordEntry[]

  // Status flags
  isSuspended     Boolean   @default(false) @map("is_suspended")
  isVerified      Boolean   @default(false) @map("is_verified")
  isApproved      Boolean   @default(false) @map("is_approved") // Admin approval required
  approvedAt      DateTime? @map("approved_at")
  approvedBy      String?   @map("approved_by")
  rejectionReason String?   @map("rejection_reason") @db.Text
  lastLoginAt     DateTime? @map("last_login_at")
  lastLoginIp     String?   @map("last_login_ip")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([stripeCustomerId])
  @@index([referralCode])
  @@index([role])
  @@index([isSuspended])
  @@map("users")
}

model Account {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@map("password_reset_tokens")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// =============================================================================
// MULTI-TENANCY: ORGANIZATIONS & TEAMS
// =============================================================================

model Organization {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  logo        String?
  description String? @db.Text
  website     String?

  // Billing
  stripeCustomerId   String?            @unique @map("stripe_customer_id")
  subscriptionId     String?            @map("subscription_id")
  subscriptionStatus SubscriptionStatus @default(TRIALING) @map("subscription_status")
  planId             String?            @map("plan_id")
  plan               Plan?              @relation(fields: [planId], references: [id])
  trialEndsAt        DateTime?          @map("trial_ends_at")
  billingEmail       String?            @map("billing_email")

  // Limits based on plan
  maxMembers  Int @default(5) @map("max_members")
  maxProjects Int @default(10) @map("max_projects")

  // Owner
  ownerId String @map("owner_id")
  owner   User   @relation("OrganizationOwner", fields: [ownerId], references: [id])

  // Relations
  members      OrganizationMember[]
  invitations  Invitation[]
  teams        Team[]
  projects     Project[]
  wallets      Wallet[]
  invoices     Invoice[]
  activityLogs ActivityLog[]
  apiKeys      ApiKey[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([ownerId])
  @@map("organizations")
}

model OrganizationMember {
  id             String           @id @default(cuid())
  organizationId String           @map("organization_id")
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String           @map("user_id")
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           OrganizationRole @default(MEMBER)

  // Team memberships within org
  teamMemberships TeamMember[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, userId])
  @@map("organization_members")
}

model Team {
  id             String       @id @default(cuid())
  name           String
  description    String?
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        TeamMember[]
  projects       Project[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, name])
  @@map("teams")
}

model TeamMember {
  id       String             @id @default(cuid())
  teamId   String             @map("team_id")
  team     Team               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  memberId String             @map("member_id")
  member   OrganizationMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  role     TeamRole           @default(MEMBER)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([teamId, memberId])
  @@map("team_members")
}

model Invitation {
  id             String           @id @default(cuid())
  email          String
  token          String           @unique
  organizationId String           @map("organization_id")
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           OrganizationRole @default(MEMBER)
  invitedById    String           @map("invited_by_id")
  invitedBy      User             @relation("InvitationSender", fields: [invitedById], references: [id])
  status         InvitationStatus @default(PENDING)
  expiresAt      DateTime         @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([token])
  @@index([email])
  @@map("invitations")
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum TeamRole {
  LEAD
  MEMBER
  VIEWER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

// =============================================================================
// BILLING & SUBSCRIPTIONS
// =============================================================================

model Plan {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text

  // Pricing
  priceMonthly         Int     @map("price_monthly") // in cents
  priceYearly          Int     @map("price_yearly") // in cents
  stripePriceIdMonthly String? @map("stripe_price_id_monthly")
  stripePriceIdYearly  String? @map("stripe_price_id_yearly")
  stripeProductId      String? @map("stripe_product_id")

  // Features & Limits
  maxMembers  Int   @default(5) @map("max_members")
  maxProjects Int   @default(10) @map("max_projects")
  maxStorage  Int   @default(5120) @map("max_storage") // in MB
  maxApiCalls Int   @default(10000) @map("max_api_calls")
  features    Json? // JSON array of feature flags

  // Plan metadata
  isPopular    Boolean @default(false) @map("is_popular")
  isEnterprise Boolean @default(false) @map("is_enterprise")
  sortOrder    Int     @default(0) @map("sort_order")
  active       Boolean @default(true)

  organizations Organization[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("plans")
}

model Invoice {
  id              String       @id @default(cuid())
  stripeInvoiceId String?      @unique @map("stripe_invoice_id")
  organizationId  String       @map("organization_id")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  amount   Int // in cents
  currency String        @default("usd")
  status   InvoiceStatus @default(DRAFT)

  invoiceNumber String? @map("invoice_number")
  invoiceUrl    String? @map("invoice_url")
  pdfUrl        String? @map("pdf_url")

  periodStart DateTime? @map("period_start")
  periodEnd   DateTime? @map("period_end")
  dueDate     DateTime? @map("due_date")
  paidAt      DateTime? @map("paid_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([organizationId])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

// =============================================================================
// FINTECH FEATURES
// =============================================================================

model Wallet {
  id               String  @id @default(cuid())
  name             String
  currency         String  @default("USD")
  balance          Decimal @default(0) @db.Decimal(19, 4)
  availableBalance Decimal @default(0) @map("available_balance") @db.Decimal(19, 4)
  pendingBalance   Decimal @default(0) @map("pending_balance") @db.Decimal(19, 4)

  // Owner (either user or organization)
  userId         String?       @map("user_id")
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  type   WalletType   @default(PERSONAL)
  status WalletStatus @default(ACTIVE)

  // Transactions
  outgoingTransactions Transaction[] @relation("WalletOutgoing")
  incomingTransactions Transaction[] @relation("WalletIncoming")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([organizationId])
  @@map("wallets")
}

model Transaction {
  id          String @id @default(cuid())
  referenceId String @unique @default(cuid()) @map("reference_id")

  // Amount
  amount   Decimal @db.Decimal(19, 4)
  fee      Decimal @default(0) @db.Decimal(19, 4)
  currency String  @default("USD")

  // Type & Status
  type   TransactionType
  status TransactionStatus @default(PENDING)

  // Description
  description String?
  metadata    Json?

  // Wallets
  fromWalletId String? @map("from_wallet_id")
  fromWallet   Wallet? @relation("WalletOutgoing", fields: [fromWalletId], references: [id])
  toWalletId   String? @map("to_wallet_id")
  toWallet     Wallet? @relation("WalletIncoming", fields: [toWalletId], references: [id])

  // Users (for P2P)
  senderId   String? @map("sender_id")
  sender     User?   @relation("TransactionSender", fields: [senderId], references: [id])
  receiverId String? @map("receiver_id")
  receiver   User?   @relation("TransactionReceiver", fields: [receiverId], references: [id])

  // External references
  stripePaymentId String? @map("stripe_payment_id")

  processedAt   DateTime? @map("processed_at")
  failedAt      DateTime? @map("failed_at")
  failureReason String?   @map("failure_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([referenceId])
  @@index([fromWalletId])
  @@index([toWalletId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

enum WalletType {
  PERSONAL
  BUSINESS
  SAVINGS
}

enum WalletStatus {
  ACTIVE
  FROZEN
  CLOSED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
  PAYMENT
  REFUND
  FEE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELED
  REFUNDED
}

// =============================================================================
// PROJECTS & CONTENT
// =============================================================================

model Project {
  id          String  @id @default(cuid())
  name        String
  slug        String
  description String? @db.Text

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teamId         String?      @map("team_id")
  team           Team?        @relation(fields: [teamId], references: [id])

  status ProjectStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, slug])
  @@map("projects")
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  published Boolean  @default(false)
  author    User     @relation(fields: [authorId], references: [id])
  authorId  String   @map("author_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([authorId])
  @@map("posts")
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

// =============================================================================
// ACTIVITY & NOTIFICATIONS
// =============================================================================

model ActivityLog {
  id         String  @id @default(cuid())
  action     String
  entityType String  @map("entity_type")
  entityId   String  @map("entity_id")
  metadata   Json?
  ipAddress  String? @map("ip_address")
  userAgent  String? @map("user_agent")

  userId         String?       @map("user_id")
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([organizationId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

model Notification {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    NotificationType
  title   String
  message String           @db.Text
  data    Json?
  read    Boolean          @default(false)
  readAt  DateTime?        @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([read])
  @@map("notifications")
}

enum NotificationType {
  SYSTEM
  BILLING
  TEAM
  SECURITY
  TRANSACTION
}

// =============================================================================
// API KEYS
// =============================================================================

model ApiKey {
  id        String @id @default(cuid())
  name      String
  key       String @unique
  hashedKey String @map("hashed_key")

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  scopes     String[]  @default([])
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  active     Boolean   @default(true)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([key])
  @@index([organizationId])
  @@map("api_keys")
}

// =============================================================================
// TOKEN WALLET SYSTEM (ADVANCIA)
// =============================================================================

model TokenWallet {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Balances
  balance        Decimal @default(0) @db.Decimal(19, 4)
  lockedBalance  Decimal @default(0) @map("locked_balance") @db.Decimal(19, 4)
  lifetimeEarned Decimal @default(0) @map("lifetime_earned") @db.Decimal(19, 4)
  lifetimeSpent  Decimal @default(0) @map("lifetime_spent") @db.Decimal(19, 4)

  // Token info
  tokenSymbol  String  @default("ADV") @map("token_symbol")
  exchangeRate Decimal @default(0.10) @map("exchange_rate") @db.Decimal(10, 4) // 1 ADV = $0.10

  // Transactions
  transactions TokenTransaction[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("token_wallets")
}

model TokenTransaction {
  id       String      @id @default(cuid())
  walletId String      @map("wallet_id")
  wallet   TokenWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  type         TokenTransactionType
  amount       Decimal              @db.Decimal(19, 4)
  fee          Decimal              @default(0) @db.Decimal(19, 4)
  balanceAfter Decimal              @map("balance_after") @db.Decimal(19, 4)

  // For transfers
  toUserId   String? @map("to_user_id")
  fromUserId String? @map("from_user_id")

  // Reference to rewards/achievements
  rewardId      String? @map("reward_id")
  achievementId String? @map("achievement_id")

  description String?
  metadata    Json?
  status      TokenTxStatus @default(COMPLETED)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@map("token_transactions")
}

enum TokenTransactionType {
  EARN // Earned from transactions/activities
  BONUS // 15% bonus on credits
  REWARD_CLAIM // Claimed from rewards
  ACHIEVEMENT // Achievement bonus
  TIER_BONUS // Tier upgrade bonus
  STREAK_BONUS // Daily streak bonus
  REFERRAL // Referral bonus
  WITHDRAW // Withdraw to external
  CASH_OUT // Convert to USD
  TRANSFER_IN // Received from another user
  TRANSFER_OUT // Sent to another user
  PURCHASE // Spent on platform
  FEE // Platform fees
}

enum TokenTxStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELED
}

// =============================================================================
// REWARDS & GAMIFICATION SYSTEM
// =============================================================================

model UserRewards {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Points & Tier
  totalPoints    Int      @default(0) @map("total_points")
  currentTier    UserTier @default(BRONZE) @map("current_tier")
  tierMultiplier Decimal  @default(1.0) @map("tier_multiplier") @db.Decimal(3, 2)

  // Streaks
  currentStreak Int       @default(0) @map("current_streak")
  longestStreak Int       @default(0) @map("longest_streak")
  lastCheckIn   DateTime? @map("last_check_in")

  // Stats
  totalRewardsClaimed Int @default(0) @map("total_rewards_claimed")
  totalAchievements   Int @default(0) @map("total_achievements")

  // Relations
  achievements   UserAchievement[]
  claimedRewards ClaimedReward[]
  milestones     UserMilestone[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_rewards")
}

model Achievement {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String
  icon        String?

  // Requirements
  category        AchievementCategory
  requirement     Int // e.g., 10 transactions, 7 day streak
  requirementType String              @map("requirement_type") // transactions, streak, referrals, etc.

  // Rewards
  pointsReward Int     @default(0) @map("points_reward")
  tokenReward  Decimal @default(0) @map("token_reward") @db.Decimal(19, 4)
  badgeUrl     String? @map("badge_url")

  // Metadata
  isSecret  Boolean @default(false) @map("is_secret")
  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  // Relations
  userAchievements UserAchievement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String      @map("user_id")
  userRewards   UserRewards @relation(fields: [userId], references: [userId], onDelete: Cascade)
  achievementId String      @map("achievement_id")
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  progress    Int       @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  claimed     Boolean   @default(false)
  claimedAt   DateTime? @map("claimed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Reward {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String
  icon        String?

  // Reward details
  type         RewardType
  tokenAmount  Decimal    @default(0) @map("token_amount") @db.Decimal(19, 4)
  pointsAmount Int        @default(0) @map("points_amount")

  // Requirements
  requiredTier   UserTier? @map("required_tier")
  requiredPoints Int       @default(0) @map("required_points")

  // Limits
  maxClaims     Int?      @map("max_claims") // null = unlimited
  claimCooldown Int?      @map("claim_cooldown") // hours between claims
  expiresAt     DateTime? @map("expires_at")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  // Relations
  claimedRewards ClaimedReward[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("rewards")
}

model ClaimedReward {
  id          String      @id @default(cuid())
  userId      String      @map("user_id")
  userRewards UserRewards @relation(fields: [userId], references: [userId], onDelete: Cascade)
  rewardId    String      @map("reward_id")
  reward      Reward      @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  tokenAmount  Decimal @map("token_amount") @db.Decimal(19, 4)
  pointsAmount Int     @map("points_amount")

  claimedAt DateTime @default(now()) @map("claimed_at")

  @@index([userId])
  @@index([rewardId])
  @@map("claimed_rewards")
}

model Milestone {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String
  icon        String?

  // Milestone requirements
  type        MilestoneType
  targetValue Int           @map("target_value")

  // Rewards
  tokenReward  Decimal @default(0) @map("token_reward") @db.Decimal(19, 4)
  pointsReward Int     @default(0) @map("points_reward")

  isActive  Boolean @default(true) @map("is_active")
  sortOrder Int     @default(0) @map("sort_order")

  // Relations
  userMilestones UserMilestone[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("milestones")
}

model UserMilestone {
  id          String      @id @default(cuid())
  userId      String      @map("user_id")
  userRewards UserRewards @relation(fields: [userId], references: [userId], onDelete: Cascade)
  milestoneId String      @map("milestone_id")
  milestone   Milestone   @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  progress    Int       @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")
  claimed     Boolean   @default(false)
  claimedAt   DateTime? @map("claimed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, milestoneId])
  @@map("user_milestones")
}

model Leaderboard {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  period      LeaderboardPeriod
  periodStart DateTime          @map("period_start")
  periodEnd   DateTime          @map("period_end")

  totalPoints Int     @default(0) @map("total_points")
  totalTokens Decimal @default(0) @map("total_tokens") @db.Decimal(19, 4)
  rank        Int?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, period, periodStart])
  @@index([period, periodStart])
  @@index([totalPoints])
  @@map("leaderboards")
}

enum UserTier {
  BRONZE // 0 points, 1.0x multiplier
  SILVER // 1,000 points, 1.2x multiplier
  GOLD // 5,000 points, 1.5x multiplier
  PLATINUM // 15,000 points, 2.0x multiplier
  DIAMOND // 50,000 points, 3.0x multiplier
}

enum AchievementCategory {
  TRANSACTIONS
  STREAKS
  REFERRALS
  MILESTONES
  SPECIAL
  SOCIAL
}

enum RewardType {
  DAILY
  WEEKLY
  MONTHLY
  TIER_BONUS
  SPECIAL
  PROMOTIONAL
}

enum MilestoneType {
  TOTAL_TRANSACTIONS
  TOTAL_VOLUME
  TOTAL_TOKENS
  REFERRALS
  STREAK_DAYS
  ACCOUNT_AGE
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

// =============================================================================
// HEALTH MONITORING SYSTEM (MEDBED)
// =============================================================================

model HealthProfile {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  dateOfBirth DateTime? @map("date_of_birth")
  gender      Gender?
  height      Decimal?  @db.Decimal(5, 2) // cm
  bloodType   String?   @map("blood_type")

  // Health goals
  targetWeight     Decimal? @map("target_weight") @db.Decimal(5, 2) // kg
  targetSteps      Int      @default(10000) @map("target_steps")
  targetSleepHours Decimal  @default(8) @map("target_sleep_hours") @db.Decimal(3, 1)
  targetCalories   Int?     @map("target_calories")

  // Current health score (calculated)
  healthScore     Int       @default(70) @map("health_score")
  lastScoreUpdate DateTime? @map("last_score_update")

  // Relations
  readings HealthReading[]
  goals    HealthGoal[]
  alerts   HealthAlert[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("health_profiles")
}

model HealthReading {
  id        String        @id @default(cuid())
  profileId String        @map("profile_id")
  profile   HealthProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Vital signs
  heartRate              Int?     @map("heart_rate") // BPM
  bloodPressureSystolic  Int?     @map("bp_systolic")
  bloodPressureDiastolic Int?     @map("bp_diastolic")
  oxygenSaturation       Decimal? @map("oxygen_saturation") @db.Decimal(4, 1) // SpO2%
  temperature            Decimal? @db.Decimal(4, 1) // Celsius

  // Activity
  steps          Int?
  caloriesBurned Int?     @map("calories_burned")
  activeMinutes  Int?     @map("active_minutes")
  distance       Decimal? @db.Decimal(8, 2) // km

  // Sleep
  sleepHours   Decimal?      @map("sleep_hours") @db.Decimal(4, 2)
  sleepQuality SleepQuality? @map("sleep_quality")

  // Body
  weight  Decimal? @db.Decimal(5, 2) // kg
  bodyFat Decimal? @map("body_fat") @db.Decimal(4, 1) // %

  // Mental
  mood        MoodLevel?
  stressLevel Int?       @map("stress_level") // 1-10

  // Source
  source   ReadingSource @default(MANUAL)
  deviceId String?       @map("device_id")

  notes      String?
  recordedAt DateTime @default(now()) @map("recorded_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([profileId])
  @@index([recordedAt])
  @@map("health_readings")
}

model HealthGoal {
  id        String        @id @default(cuid())
  profileId String        @map("profile_id")
  profile   HealthProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  type         HealthGoalType
  targetValue  Decimal        @map("target_value") @db.Decimal(10, 2)
  currentValue Decimal        @default(0) @map("current_value") @db.Decimal(10, 2)
  unit         String

  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date")

  status      GoalStatus @default(ACTIVE)
  completedAt DateTime?  @map("completed_at")

  // Rewards for completion
  tokenReward  Decimal @default(0) @map("token_reward") @db.Decimal(19, 4)
  pointsReward Int     @default(0) @map("points_reward")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([profileId])
  @@index([status])
  @@map("health_goals")
}

model HealthAlert {
  id        String        @id @default(cuid())
  profileId String        @map("profile_id")
  profile   HealthProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  type     HealthAlertType
  severity AlertSeverity
  title    String
  message  String

  metric    String? // Which metric triggered the alert
  value     Decimal? @db.Decimal(10, 2)
  threshold Decimal? @db.Decimal(10, 2)

  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime? @map("acknowledged_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([profileId])
  @@index([severity])
  @@index([acknowledged])
  @@map("health_alerts")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum SleepQuality {
  POOR
  FAIR
  GOOD
  EXCELLENT
}

enum MoodLevel {
  GREAT
  GOOD
  OKAY
  BAD
  TERRIBLE
}

enum ReadingSource {
  MANUAL
  APPLE_WATCH
  FITBIT
  GARMIN
  SAMSUNG_HEALTH
  GOOGLE_FIT
  OTHER_DEVICE
}

enum HealthGoalType {
  WEIGHT_LOSS
  WEIGHT_GAIN
  STEPS
  SLEEP
  HEART_RATE
  BLOOD_PRESSURE
  CALORIES
  EXERCISE_MINUTES
  WATER_INTAKE
  CUSTOM
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  FAILED
  PAUSED
  CANCELED
}

enum HealthAlertType {
  HIGH_HEART_RATE
  LOW_HEART_RATE
  HIGH_BLOOD_PRESSURE
  LOW_BLOOD_PRESSURE
  LOW_OXYGEN
  HIGH_TEMPERATURE
  GOAL_ACHIEVED
  STREAK_REMINDER
  INACTIVITY
  CUSTOM
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

// =============================================================================
// REFERRAL SYSTEM
// =============================================================================

model Referral {
  id         String  @id @default(cuid())
  referrerId String  @map("referrer_id")
  referrer   User    @relation("ReferralsMade", fields: [referrerId], references: [id], onDelete: Cascade)
  referredId String? @map("referred_id")
  referred   User?   @relation("ReferralsReceived", fields: [referredId], references: [id], onDelete: SetNull)

  code  String  @unique
  email String? // Email invited (before signup)

  status ReferralStatus @default(PENDING)

  // Rewards
  referrerReward Decimal   @default(0) @map("referrer_reward") @db.Decimal(19, 4)
  referredReward Decimal   @default(0) @map("referred_reward") @db.Decimal(19, 4)
  rewardsPaid    Boolean   @default(false) @map("rewards_paid")
  paidAt         DateTime? @map("paid_at")

  expiresAt   DateTime? @map("expires_at")
  completedAt DateTime? @map("completed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([referrerId])
  @@index([code])
  @@map("referrals")
}

enum ReferralStatus {
  PENDING
  SIGNED_UP
  COMPLETED
  EXPIRED
  CANCELED
}

// =============================================================================
// DEBIT CARD SYSTEM
// =============================================================================

model DebitCard {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Card details (masked)
  cardNumber  String   @map("card_number") // Last 4 digits only
  cardType    CardType @default(VIRTUAL) @map("card_type")
  expiryMonth Int      @map("expiry_month")
  expiryYear  Int      @map("expiry_year")

  // Limits
  dailyLimit    Decimal @default(1000) @map("daily_limit") @db.Decimal(19, 4)
  monthlyLimit  Decimal @default(10000) @map("monthly_limit") @db.Decimal(19, 4)
  singleTxLimit Decimal @default(500) @map("single_tx_limit") @db.Decimal(19, 4)

  // Usage tracking
  dailySpent    Decimal  @default(0) @map("daily_spent") @db.Decimal(19, 4)
  monthlySpent  Decimal  @default(0) @map("monthly_spent") @db.Decimal(19, 4)
  lastResetDate DateTime @default(now()) @map("last_reset_date")

  // Status
  status       CardStatus @default(ACTIVE)
  frozenAt     DateTime?  @map("frozen_at")
  frozenReason String?    @map("frozen_reason")

  // Linked wallet
  walletId String? @map("wallet_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("debit_cards")
}

enum CardType {
  VIRTUAL
  PHYSICAL
}

enum CardStatus {
  PENDING
  ACTIVE
  FROZEN
  EXPIRED
  CANCELED
}

// =============================================================================
// CRYPTO PAYMENTS (NOWPayments.io & Alchemy Pay)
// =============================================================================

model CryptoPayment {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Payment details
  provider   PaymentProvider
  externalId String?         @unique @map("external_id") // NOWPayments payment_id or Alchemy order_id

  // Amounts
  amount    Decimal @db.Decimal(19, 8) // Crypto amount
  amountUsd Decimal @map("amount_usd") @db.Decimal(19, 4)
  currency  String // BTC, ETH, USDT, etc.

  // Fiat conversion (for Alchemy Pay)
  fiatAmount   Decimal? @map("fiat_amount") @db.Decimal(19, 4)
  fiatCurrency String?  @map("fiat_currency") // USD, EUR, etc.
  exchangeRate Decimal? @map("exchange_rate") @db.Decimal(19, 8)

  // Payment addresses
  payAddress   String? @map("pay_address")
  payinAddress String? @map("payin_address")

  // Status
  status CryptoPaymentStatus @default(WAITING)

  // Metadata
  description    String?
  metadata       Json?
  ipnCallbackUrl String? @map("ipn_callback_url")

  // Timestamps
  expiresAt   DateTime? @map("expires_at")
  confirmedAt DateTime? @map("confirmed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([externalId])
  @@index([status])
  @@map("crypto_payments")
}

model CryptoWithdrawal {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Withdrawal details
  provider   PaymentProvider
  externalId String?         @unique @map("external_id")

  // Amounts
  amount    Decimal @db.Decimal(19, 8)
  amountUsd Decimal @map("amount_usd") @db.Decimal(19, 4)
  currency  String
  fee       Decimal @default(0) @db.Decimal(19, 8)

  // Destination
  address String
  network String? // ETH, BSC, TRC20, etc.

  // Status
  status WithdrawalStatus @default(PENDING)
  txHash String?          @map("tx_hash")

  // Metadata
  metadata Json?

  processedAt   DateTime? @map("processed_at")
  failedAt      DateTime? @map("failed_at")
  failureReason String?   @map("failure_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("crypto_withdrawals")
}

enum PaymentProvider {
  NOWPAYMENTS
  ALCHEMY_PAY
  STRIPE
  MANUAL
}

enum CryptoPaymentStatus {
  WAITING
  CONFIRMING
  CONFIRMED
  SENDING
  PARTIALLY_PAID
  FINISHED
  FAILED
  REFUNDED
  EXPIRED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELED
}

// =============================================================================
// MEDBED SYSTEM
// =============================================================================

model MedBedDevice {
  id           String      @id @default(cuid())
  name         String
  serialNumber String      @unique @map("serial_number")
  model        MedBedModel

  // Location
  facilityId String         @map("facility_id")
  facility   MedBedFacility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  roomNumber String?        @map("room_number")

  // Status
  status          DeviceStatus @default(OFFLINE)
  lastOnline      DateTime?    @map("last_online")
  lastMaintenance DateTime?    @map("last_maintenance")
  nextMaintenance DateTime?    @map("next_maintenance")

  // Capabilities
  capabilities      Json? // Array of supported treatments
  maxSessionMinutes Int   @default(60) @map("max_session_minutes")

  // Pricing
  pricePerMinute  Decimal  @default(1) @map("price_per_minute") @db.Decimal(10, 4)
  pricePerSession Decimal? @map("price_per_session") @db.Decimal(10, 4)

  // Relations
  sessions        MedBedSession[]
  bookings        MedBedBooking[]
  maintenanceLogs MedBedMaintenance[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([facilityId])
  @@index([status])
  @@map("medbed_devices")
}

model MedBedFacility {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text

  // Location
  address    String
  city       String
  state      String?
  country    String
  postalCode String?  @map("postal_code")
  latitude   Decimal? @db.Decimal(10, 8)
  longitude  Decimal? @db.Decimal(11, 8)
  timezone   String   @default("UTC")

  // Contact
  phone   String?
  email   String?
  website String?

  // Operating hours (JSON: { "monday": { "open": "09:00", "close": "18:00" }, ... })
  operatingHours Json? @map("operating_hours")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Relations
  devices  MedBedDevice[]
  bookings MedBedBooking[]
  staff    MedBedStaff[]

  // Organization (if multi-tenant)
  organizationId String? @map("organization_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([city, country])
  @@map("medbed_facilities")
}

model MedBedBooking {
  id            String @id @default(cuid())
  bookingNumber String @unique @map("booking_number")

  // User
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Device & Facility
  deviceId   String         @map("device_id")
  device     MedBedDevice   @relation(fields: [deviceId], references: [id])
  facilityId String         @map("facility_id")
  facility   MedBedFacility @relation(fields: [facilityId], references: [id])

  // Timing
  scheduledStart  DateTime @map("scheduled_start")
  scheduledEnd    DateTime @map("scheduled_end")
  durationMinutes Int      @map("duration_minutes")

  // Treatment
  treatmentType  TreatmentType @map("treatment_type")
  treatmentNotes String?       @map("treatment_notes") @db.Text

  // Pricing
  priceTotal    Decimal  @map("price_total") @db.Decimal(19, 4)
  priceCurrency String   @default("USD") @map("price_currency")
  tokensCost    Decimal? @map("tokens_cost") @db.Decimal(19, 4) // If paid with ADV tokens

  // Payment
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  paymentMethod String?       @map("payment_method")
  paymentId     String?       @map("payment_id") // Reference to CryptoPayment or Stripe

  // Status
  status BookingStatus @default(PENDING)

  // Session (created when booking starts)
  session MedBedSession?

  // Cancellation
  canceledAt   DateTime? @map("canceled_at")
  cancelReason String?   @map("cancel_reason")
  refundAmount Decimal?  @map("refund_amount") @db.Decimal(19, 4)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([deviceId])
  @@index([facilityId])
  @@index([scheduledStart])
  @@index([status])
  @@map("medbed_bookings")
}

model MedBedSession {
  id String @id @default(cuid())

  // Booking reference
  bookingId String        @unique @map("booking_id")
  booking   MedBedBooking @relation(fields: [bookingId], references: [id])

  // Device
  deviceId String       @map("device_id")
  device   MedBedDevice @relation(fields: [deviceId], references: [id])

  // User
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Timing
  startedAt      DateTime  @map("started_at")
  endedAt        DateTime? @map("ended_at")
  actualDuration Int?      @map("actual_duration") // minutes

  // Treatment data
  treatmentType     TreatmentType @map("treatment_type")
  treatmentSettings Json?         @map("treatment_settings")

  // Health readings during session
  readings MedBedReading[]

  // Results
  status          SessionStatus @default(IN_PROGRESS)
  completionNotes String?       @map("completion_notes") @db.Text

  // Staff who supervised
  supervisorId String?      @map("supervisor_id")
  supervisor   MedBedStaff? @relation(fields: [supervisorId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([deviceId])
  @@index([userId])
  @@map("medbed_sessions")
}

model MedBedReading {
  id        String        @id @default(cuid())
  sessionId String        @map("session_id")
  session   MedBedSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Timestamp within session
  timestamp   DateTime @default(now())
  minutesMark Int      @map("minutes_mark") // Minutes since session start

  // Vital signs
  heartRate        Int?     @map("heart_rate")
  bloodPressureSys Int?     @map("bp_systolic")
  bloodPressureDia Int?     @map("bp_diastolic")
  oxygenSaturation Decimal? @map("oxygen_saturation") @db.Decimal(4, 1)
  temperature      Decimal? @db.Decimal(4, 1)

  // MedBed-specific readings
  brainwaveAlpha Decimal? @map("brainwave_alpha") @db.Decimal(6, 2)
  brainwaveBeta  Decimal? @map("brainwave_beta") @db.Decimal(6, 2)
  brainwaveTheta Decimal? @map("brainwave_theta") @db.Decimal(6, 2)
  brainwaveDelta Decimal? @map("brainwave_delta") @db.Decimal(6, 2)

  // Energy readings
  bioFieldStrength  Decimal? @map("bio_field_strength") @db.Decimal(8, 2)
  cellularResonance Decimal? @map("cellular_resonance") @db.Decimal(8, 2)

  // Device settings at this point
  devicePowerLevel Int?     @map("device_power_level")
  frequencyHz      Decimal? @map("frequency_hz") @db.Decimal(10, 4)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@index([timestamp])
  @@map("medbed_readings")
}

model MedBedStaff {
  id     String  @id @default(cuid())
  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id])

  facilityId String         @map("facility_id")
  facility   MedBedFacility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  // Staff info
  name  String
  email String
  phone String?
  role  StaffRole

  // Certifications
  certifications Json? // Array of certification objects
  certifiedUntil DateTime? @map("certified_until")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Sessions supervised
  sessions MedBedSession[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([facilityId, email])
  @@index([facilityId])
  @@map("medbed_staff")
}

model MedBedMaintenance {
  id       String       @id @default(cuid())
  deviceId String       @map("device_id")
  device   MedBedDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  type        MaintenanceType
  description String          @db.Text

  // Timing
  scheduledDate DateTime  @map("scheduled_date")
  completedDate DateTime? @map("completed_date")

  // Technician
  technicianName  String? @map("technician_name")
  technicianNotes String? @map("technician_notes") @db.Text

  // Parts replaced
  partsReplaced Json?    @map("parts_replaced")
  cost          Decimal? @db.Decimal(10, 2)

  status MaintenanceStatus @default(SCHEDULED)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([deviceId])
  @@index([scheduledDate])
  @@map("medbed_maintenance")
}

enum MedBedModel {
  STANDARD
  ADVANCED
  PREMIUM
  RESEARCH
}

enum DeviceStatus {
  ONLINE
  OFFLINE
  IN_USE
  MAINTENANCE
  ERROR
}

enum TreatmentType {
  GENERAL_WELLNESS
  CELLULAR_REGENERATION
  PAIN_MANAGEMENT
  SLEEP_OPTIMIZATION
  MENTAL_CLARITY
  DETOXIFICATION
  IMMUNE_BOOST
  ANTI_AGING
  INJURY_RECOVERY
  CHRONIC_CONDITION
  DIAGNOSTIC_SCAN
  CUSTOM
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  IN_PROGRESS
  COMPLETED
  CANCELED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  INTERRUPTED
  CANCELED
}

enum StaffRole {
  TECHNICIAN
  SUPERVISOR
  MEDICAL_OFFICER
  ADMIN
}

enum MaintenanceType {
  ROUTINE
  CALIBRATION
  REPAIR
  UPGRADE
  INSPECTION
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELED
}

// =============================================================================
// ADMIN & USER MANAGEMENT
// =============================================================================

model AdminAction {
  id      String @id @default(cuid())
  adminId String @map("admin_id")
  admin   User   @relation("AdminActions", fields: [adminId], references: [id])

  targetUserId String? @map("target_user_id")
  targetUser   User?   @relation("UserActions", fields: [targetUserId], references: [id])

  action       AdminActionType
  resourceType String?         @map("resource_type") // User, Organization, Payment, etc.
  resourceId   String?         @map("resource_id")

  description String @db.Text
  metadata    Json?

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([adminId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_actions")
}

model UserSuspension {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  adminId String @map("admin_id")
  admin   User   @relation("SuspensionsByAdmin", fields: [adminId], references: [id])

  reason String         @db.Text
  type   SuspensionType

  startDate DateTime  @default(now()) @map("start_date")
  endDate   DateTime? @map("end_date") // null = permanent

  isActive   Boolean   @default(true) @map("is_active")
  liftedAt   DateTime? @map("lifted_at")
  liftedBy   String?   @map("lifted_by")
  liftReason String?   @map("lift_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([adminId])
  @@index([isActive])
  @@map("user_suspensions")
}

model EmailTemplate {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  subject     String
  htmlContent String  @map("html_content") @db.Text
  textContent String? @map("text_content") @db.Text

  // Variables available in template
  variables Json? // ["userName", "resetLink", etc.]

  category EmailCategory
  isActive Boolean       @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("email_templates")
}

model EmailLog {
  id String @id @default(cuid())

  // Recipient
  toEmail  String  @map("to_email")
  toUserId String? @map("to_user_id")
  toUser   User?   @relation(fields: [toUserId], references: [id])

  // Email details
  fromEmail  String  @map("from_email")
  subject    String
  templateId String? @map("template_id")

  // Provider info
  provider   EmailProvider @default(RESEND)
  externalId String?       @unique @map("external_id") // Resend message ID

  // Status
  status      EmailStatus @default(PENDING)
  sentAt      DateTime?   @map("sent_at")
  deliveredAt DateTime?   @map("delivered_at")
  openedAt    DateTime?   @map("opened_at")
  clickedAt   DateTime?   @map("clicked_at")
  bouncedAt   DateTime?   @map("bounced_at")

  // Error tracking
  errorMessage String? @map("error_message")

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([toEmail])
  @@index([toUserId])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

model FileUpload {
  id String @id @default(cuid())

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id])

  // File info
  filename     String
  originalName String @map("original_name")
  mimeType     String @map("mime_type")
  size         Int // bytes

  // Storage
  provider StorageProvider @default(CLOUDFLARE_R2)
  bucket   String
  key      String // Full path in bucket
  url      String? // Public URL if available

  // Metadata
  metadata Json?
  isPublic Boolean @default(false) @map("is_public")

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([bucket, key])
  @@map("file_uploads")
}

model SystemSetting {
  id    String      @id @default(cuid())
  key   String      @unique
  value String      @db.Text
  type  SettingType @default(STRING)

  category    String  @default("general")
  description String?

  isPublic Boolean @default(false) @map("is_public")

  updatedBy String? @map("updated_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("system_settings")
}

model AuditLog {
  id String @id @default(cuid())

  // Event classification
  eventType String @map("event_type")
  severity  String @default("INFO")

  // User context
  userId    String? @map("user_id")
  user      User?   @relation(fields: [userId], references: [id])
  sessionId String? @map("session_id")

  // Request context
  ipAddress String  @map("ip_address")
  userAgent String? @map("user_agent")

  // Event details
  action     String?
  resource   String?
  entityType String? @map("entity_type")
  entityId   String? @map("entity_id")

  // Data changes
  oldValues Json?   @map("old_values")
  newValues Json?   @map("new_values")
  details   String? @db.Text
  metadata  String? @db.Text

  // Timestamps
  timestamp DateTime @default(now())
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AdminActionType {
  // User management
  USER_CREATE
  USER_UPDATE
  USER_DELETE
  USER_SUSPEND
  USER_UNSUSPEND
  USER_VERIFY
  USER_RESET_PASSWORD
  USER_IMPERSONATE
  USER_ROLE_CHANGE

  // Financial
  WALLET_ADJUST
  PAYMENT_REFUND
  PAYMENT_VOID
  SUBSCRIPTION_CANCEL
  SUBSCRIPTION_MODIFY

  // Content
  CONTENT_DELETE
  CONTENT_HIDE
  CONTENT_RESTORE

  // System
  SETTING_CHANGE
  FEATURE_TOGGLE
  MAINTENANCE_MODE

  // Security
  IP_BAN
  IP_UNBAN
  RATE_LIMIT_OVERRIDE
}

enum SuspensionType {
  WARNING
  TEMPORARY
  PERMANENT
  REVIEW
}

enum EmailCategory {
  TRANSACTIONAL
  MARKETING
  NOTIFICATION
  SECURITY
  SYSTEM
}

enum EmailProvider {
  RESEND
  SENDGRID
  SES
  SMTP
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
  SPAM
}

enum StorageProvider {
  CLOUDFLARE_R2
  AWS_S3
  LOCAL
}

enum SettingType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// =============================================================================
// BLOG & CONTENT MANAGEMENT SYSTEM
// =============================================================================

model BlogPost {
  id            String  @id @default(cuid())
  title         String
  slug          String  @unique
  excerpt       String? @db.Text
  content       String  @db.Text
  contentHtml   String? @map("content_html") @db.Text
  featuredImage String? @map("featured_image")

  // SEO
  metaTitle       String?  @map("meta_title")
  metaDescription String?  @map("meta_description") @db.Text
  metaKeywords    String[] @map("meta_keywords")
  canonicalUrl    String?  @map("canonical_url")
  ogImage         String?  @map("og_image")

  // Status
  status      BlogPostStatus @default(DRAFT)
  publishedAt DateTime?      @map("published_at")
  scheduledAt DateTime?      @map("scheduled_at")

  // Author
  authorId String @map("author_id")
  author   User   @relation("BlogPostAuthor", fields: [authorId], references: [id])

  // Categories & Tags
  categoryId String?       @map("category_id")
  category   BlogCategory? @relation(fields: [categoryId], references: [id])
  tags       BlogPostTag[]

  // AI Generated
  isAiGenerated Boolean @default(false) @map("is_ai_generated")
  aiPrompt      String? @map("ai_prompt") @db.Text

  // Stats
  viewCount   Int  @default(0) @map("view_count")
  likeCount   Int  @default(0) @map("like_count")
  shareCount  Int  @default(0) @map("share_count")
  readingTime Int? @map("reading_time") // in minutes

  // Related
  relatedPosts BlogPost[] @relation("RelatedPosts")
  relatedTo    BlogPost[] @relation("RelatedPosts")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([status])
  @@index([authorId])
  @@index([categoryId])
  @@index([publishedAt])
  @@map("blog_posts")
}

model BlogCategory {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  color       String? // hex color for UI
  icon        String?

  // SEO
  metaTitle       String? @map("meta_title")
  metaDescription String? @map("meta_description") @db.Text

  // Hierarchy
  parentId String?        @map("parent_id")
  parent   BlogCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children BlogCategory[] @relation("CategoryHierarchy")

  posts     BlogPost[]
  sortOrder Int        @default(0) @map("sort_order")
  isActive  Boolean    @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@map("blog_categories")
}

model BlogTag {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  color       String?

  posts BlogPostTag[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@map("blog_tags")
}

model BlogPostTag {
  id     String   @id @default(cuid())
  postId String   @map("post_id")
  post   BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId  String   @map("tag_id")
  tag    BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([postId, tagId])
  @@map("blog_post_tags")
}

enum BlogPostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

// =============================================================================
// CRM - CUSTOMER RELATIONSHIP MANAGEMENT
// =============================================================================

model CrmContact {
  id String @id @default(cuid())

  // Basic Info
  firstName String  @map("first_name")
  lastName  String? @map("last_name")
  email     String?
  phone     String?
  company   String?
  jobTitle  String? @map("job_title")
  avatar    String?

  // Address
  address    String?
  city       String?
  state      String?
  country    String?
  postalCode String? @map("postal_code")

  // Social
  website  String?
  linkedin String?
  twitter  String?

  // Status
  status ContactStatus @default(LEAD)
  source ContactSource @default(OTHER)

  // Owner
  ownerId String @map("owner_id")
  owner   User   @relation("ContactOwner", fields: [ownerId], references: [id])

  // Relations
  deals      CrmDeal[]
  notes      CrmNote[]
  activities CrmActivity[]
  emails     CrmEmail[]

  // Custom fields
  customFields Json?    @map("custom_fields")
  tags         String[]

  // Scoring
  leadScore       Int       @default(0) @map("lead_score")
  lastContactedAt DateTime? @map("last_contacted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([ownerId])
  @@index([status])
  @@map("crm_contacts")
}

model CrmPipeline {
  id          String  @id @default(cuid())
  name        String
  description String?

  stages CrmStage[]
  deals  CrmDeal[]

  isDefault Boolean @default(false) @map("is_default")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("crm_pipelines")
}

model CrmStage {
  id    String  @id @default(cuid())
  name  String
  color String?

  pipelineId String      @map("pipeline_id")
  pipeline   CrmPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  deals CrmDeal[]

  probability Int @default(0) // 0-100%
  sortOrder   Int @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([pipelineId, name])
  @@map("crm_stages")
}

model CrmDeal {
  id          String  @id @default(cuid())
  name        String
  description String? @db.Text

  // Value
  value    Decimal @default(0) @db.Decimal(19, 2)
  currency String  @default("USD")

  // Pipeline & Stage
  pipelineId String      @map("pipeline_id")
  pipeline   CrmPipeline @relation(fields: [pipelineId], references: [id])
  stageId    String      @map("stage_id")
  stage      CrmStage    @relation(fields: [stageId], references: [id])

  // Contact
  contactId String     @map("contact_id")
  contact   CrmContact @relation(fields: [contactId], references: [id])

  // Owner
  ownerId String @map("owner_id")
  owner   User   @relation("DealOwner", fields: [ownerId], references: [id])

  // Status
  status      DealStatus @default(OPEN)
  probability Int        @default(0) // 0-100%

  // Dates
  expectedCloseDate DateTime? @map("expected_close_date")
  closedAt          DateTime? @map("closed_at")

  // Relations
  notes      CrmNote[]
  activities CrmActivity[]

  // Custom
  customFields Json?    @map("custom_fields")
  tags         String[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([pipelineId])
  @@index([stageId])
  @@index([contactId])
  @@index([ownerId])
  @@index([status])
  @@map("crm_deals")
}

model CrmNote {
  id      String @id @default(cuid())
  content String @db.Text

  // Relations
  contactId String?     @map("contact_id")
  contact   CrmContact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  dealId    String?     @map("deal_id")
  deal      CrmDeal?    @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Author
  authorId String @map("author_id")
  author   User   @relation("NoteAuthor", fields: [authorId], references: [id])

  isPinned Boolean @default(false) @map("is_pinned")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([contactId])
  @@index([dealId])
  @@map("crm_notes")
}

model CrmActivity {
  id          String          @id @default(cuid())
  type        CrmActivityType
  subject     String
  description String?         @db.Text

  // Relations
  contactId String?     @map("contact_id")
  contact   CrmContact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  dealId    String?     @map("deal_id")
  deal      CrmDeal?    @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Owner
  ownerId String @map("owner_id")
  owner   User   @relation("ActivityOwner", fields: [ownerId], references: [id])

  // Scheduling
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  isCompleted Boolean   @default(false) @map("is_completed")

  // Reminder
  reminderAt DateTime? @map("reminder_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([contactId])
  @@index([dealId])
  @@index([ownerId])
  @@index([dueDate])
  @@map("crm_activities")
}

model CrmEmail {
  id String @id @default(cuid())

  // Email details
  subject  String
  body     String  @db.Text
  bodyHtml String? @map("body_html") @db.Text

  // Addresses
  fromEmail String   @map("from_email")
  toEmail   String   @map("to_email")
  ccEmails  String[] @map("cc_emails")
  bccEmails String[] @map("bcc_emails")

  // Contact
  contactId String     @map("contact_id")
  contact   CrmContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Sender
  senderId String @map("sender_id")
  sender   User   @relation("EmailSender", fields: [senderId], references: [id])

  // Status
  status CrmEmailStatus @default(DRAFT)
  sentAt DateTime?      @map("sent_at")

  // Tracking
  openedAt   DateTime? @map("opened_at")
  openCount  Int       @default(0) @map("open_count")
  clickedAt  DateTime? @map("clicked_at")
  clickCount Int       @default(0) @map("click_count")

  // Thread
  threadId String? @map("thread_id")
  parentId String? @map("parent_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([contactId])
  @@index([senderId])
  @@index([threadId])
  @@map("crm_emails")
}

enum ContactStatus {
  LEAD
  PROSPECT
  CUSTOMER
  CHURNED
  INACTIVE
}

enum ContactSource {
  WEBSITE
  REFERRAL
  SOCIAL
  COLD_OUTREACH
  EVENT
  ADVERTISEMENT
  OTHER
}

enum DealStatus {
  OPEN
  WON
  LOST
}

enum CrmActivityType {
  CALL
  EMAIL
  MEETING
  TASK
  NOTE
  FOLLOW_UP
}

enum CrmEmailStatus {
  DRAFT
  SCHEDULED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

// =============================================================================
// AUTOMATION & WEBHOOKS
// =============================================================================

model Webhook {
  id     String  @id @default(cuid())
  name   String
  url    String
  secret String?

  // Events to trigger
  events String[]

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Stats
  lastTriggeredAt DateTime? @map("last_triggered_at")
  successCount    Int       @default(0) @map("success_count")
  failureCount    Int       @default(0) @map("failure_count")

  // Logs
  logs WebhookLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("webhooks")
}

model WebhookLog {
  id        String  @id @default(cuid())
  webhookId String  @map("webhook_id")
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  event   String
  payload Json

  // Response
  statusCode Int?    @map("status_code")
  response   String? @db.Text

  // Status
  success Boolean @default(false)
  error   String?

  executedAt DateTime @default(now()) @map("executed_at")

  @@index([webhookId])
  @@index([executedAt])
  @@map("webhook_logs")
}

model AutomationRule {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Trigger
  triggerType   TriggerType @map("trigger_type")
  triggerConfig Json        @map("trigger_config")

  // Actions
  actions Json // Array of action configs

  // Conditions
  conditions Json? // Optional conditions

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Stats
  runCount  Int       @default(0) @map("run_count")
  lastRunAt DateTime? @map("last_run_at")

  // Logs
  logs AutomationLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("automation_rules")
}

model AutomationLog {
  id     String         @id @default(cuid())
  ruleId String         @map("rule_id")
  rule   AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Execution
  triggerData     Json @map("trigger_data")
  actionsExecuted Json @map("actions_executed")

  // Status
  success Boolean @default(false)
  error   String?

  executedAt DateTime @default(now()) @map("executed_at")
  duration   Int? // milliseconds

  @@index([ruleId])
  @@index([executedAt])
  @@map("automation_logs")
}

model ScheduledTask {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Schedule (cron expression)
  cronExpression String @map("cron_expression")
  timezone       String @default("UTC")

  // Task
  taskType   String @map("task_type")
  taskConfig Json   @map("task_config")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Execution
  lastRunAt DateTime? @map("last_run_at")
  nextRunAt DateTime? @map("next_run_at")
  runCount  Int       @default(0) @map("run_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("scheduled_tasks")
}

enum TriggerType {
  WEBHOOK
  SCHEDULE
  EVENT
  MANUAL
}

// =============================================================================
// NEWSLETTER & EMAIL MARKETING
// =============================================================================

model NewsletterSubscriber {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?

  // Status
  status         SubscriberStatus @default(PENDING)
  confirmedAt    DateTime?        @map("confirmed_at")
  unsubscribedAt DateTime?        @map("unsubscribed_at")

  // Source
  source String?

  // Preferences
  preferences Json?
  tags        String[]

  // Token for confirmation/unsubscribe
  token String @unique @default(cuid())

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@map("newsletter_subscribers")
}

model NewsletterCampaign {
  id          String  @id @default(cuid())
  name        String
  subject     String
  previewText String? @map("preview_text")

  // Content
  content     String  @db.Text
  contentHtml String? @map("content_html") @db.Text

  // Status
  status CampaignStatus @default(DRAFT)

  // Schedule
  scheduledAt DateTime? @map("scheduled_at")
  sentAt      DateTime? @map("sent_at")

  // Stats
  recipientCount   Int @default(0) @map("recipient_count")
  openCount        Int @default(0) @map("open_count")
  clickCount       Int @default(0) @map("click_count")
  unsubscribeCount Int @default(0) @map("unsubscribe_count")
  bounceCount      Int @default(0) @map("bounce_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("newsletter_campaigns")
}

enum SubscriberStatus {
  PENDING
  CONFIRMED
  UNSUBSCRIBED
  BOUNCED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELED
}

// =============================================================================
// EMAIL ROUTING & SECURITY
// =============================================================================

model EmailRoute {
  id         String  @id @default(cuid())
  externalId String? @unique @map("external_id") // Cloudflare rule ID

  pattern     String // e.g., "support@domain.com" or "*@domain.com"
  destination String // Forward to this address

  enabled  Boolean @default(true)
  priority Int     @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([pattern])
  @@map("email_routes")
}

model EmailAlias {
  id String @id @default(cuid())

  alias       String @unique // e.g., "john@domain.com"
  targetEmail String @map("target_email")

  userId      String? @map("user_id")
  description String?

  enabled          Boolean @default(true)
  cloudflareRuleId String? @map("cloudflare_rule_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([alias])
  @@map("email_aliases")
}

model EmailSecurityLog {
  id String @id @default(cuid())

  // Event type
  eventType String @map("event_type") // phishing_detected, tracker_blocked, etc.
  severity  String @default("INFO")

  // Email details
  fromEmail String? @map("from_email")
  toEmail   String? @map("to_email")
  subject   String?

  // Analysis results
  isPhishing    Boolean @default(false) @map("is_phishing")
  phishingScore Int     @default(0) @map("phishing_score")
  trackersFound Int     @default(0) @map("trackers_found")

  // Details
  indicators String? @db.Text // JSON array of indicators
  metadata   String? @db.Text // Additional metadata

  // Action taken
  action String? // blocked, quarantined, delivered, etc.

  createdAt DateTime @default(now()) @map("created_at")

  @@index([eventType])
  @@index([fromEmail])
  @@index([createdAt])
  @@map("email_security_logs")
}

// =============================================================================
// PASSWORD MANAGER
// =============================================================================

model PasswordEntry {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  siteName String  @map("site_name")
  siteUrl  String? @map("site_url")
  username String?
  password String // Encrypted on client side
  notes    String? @db.Text
  category String  @default("other")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([category])
  @@map("password_entries")
}

model DomainSecurityConfig {
  id String @id @default(cuid())

  domain String @unique

  // DNS Security
  dnssecEnabled Boolean @default(false) @map("dnssec_enabled")
  caaConfigured Boolean @default(false) @map("caa_configured")

  // Email Security
  spfConfigured   Boolean @default(false) @map("spf_configured")
  dkimConfigured  Boolean @default(false) @map("dkim_configured")
  dmarcConfigured Boolean @default(false) @map("dmarc_configured")
  dmarcPolicy     String? @map("dmarc_policy") // none, quarantine, reject

  // SSL/TLS
  sslMode       String? @map("ssl_mode") // off, flexible, full, strict
  minTlsVersion String? @map("min_tls_version")

  // Cloudflare Security
  wafEnabled     Boolean @default(false) @map("waf_enabled")
  botProtection  Boolean @default(false) @map("bot_protection")
  ddosProtection Boolean @default(true) @map("ddos_protection")

  // Last check
  lastHealthCheck DateTime? @map("last_health_check")
  healthScore     Int       @default(0) @map("health_score")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("domain_security_configs")
}

// =============================================================================
// ANALYTICS & TRACKING
// =============================================================================

model AnalyticsEvent {
  id String @id @default(cuid())

  // Event info
  eventType  String  @map("event_type") // page_view, click, conversion, etc.
  eventName  String  @map("event_name")
  eventValue String? @map("event_value")

  // User context
  userId    String? @map("user_id")
  sessionId String? @map("session_id")

  // Page context
  pageUrl   String? @map("page_url")
  pageTitle String? @map("page_title")
  referrer  String?

  // Device info
  userAgent String? @map("user_agent")
  ipAddress String? @map("ip_address")
  country   String?
  city      String?
  device    String? // mobile, desktop, tablet
  browser   String?
  os        String?

  // Custom data
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([eventType])
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("analytics_events")
}

// =============================================================================
// ERROR LOGGING
// =============================================================================

model ErrorLog {
  id String @id @default(cuid())

  // Error info
  errorType  String  @map("error_type") // runtime, api, database, auth, etc.
  errorCode  String? @map("error_code")
  message    String  @db.Text
  stackTrace String? @map("stack_trace") @db.Text

  // Context
  source        String? // api route, component, service
  userId        String? @map("user_id")
  requestUrl    String? @map("request_url")
  requestMethod String? @map("request_method")
  requestBody   String? @map("request_body") @db.Text

  // Severity
  severity ErrorSeverity @default(ERROR)

  // Resolution
  resolved   Boolean   @default(false)
  resolvedAt DateTime? @map("resolved_at")
  resolvedBy String?   @map("resolved_by")
  resolution String?   @db.Text

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([errorType])
  @@index([severity])
  @@index([resolved])
  @@index([createdAt])
  @@map("error_logs")
}

enum ErrorSeverity {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

// =============================================================================
// AI AGENT SYSTEM
// =============================================================================

model AIJob {
  id String @id @default(cuid())

  // Job info
  jobType  String      @map("job_type") // code, research, seo, blog, etc.
  status   AIJobStatus @default(PENDING)
  priority Int         @default(5) // 1-10, higher = more urgent

  // Task details
  taskDescription String @map("task_description") @db.Text
  inputData       Json?  @map("input_data")
  outputData      Json?  @map("output_data")

  // Agent assignment
  assignedAgent  String? @map("assigned_agent")
  orchestratorId String? @map("orchestrator_id")

  // Execution
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3) @map("max_attempts")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  failedAt      DateTime? @map("failed_at")
  failureReason String?   @map("failure_reason") @db.Text

  // Cost tracking
  tokensUsed    Int     @default(0) @map("tokens_used")
  estimatedCost Decimal @default(0) @map("estimated_cost") @db.Decimal(10, 6)

  // User context
  userId String? @map("user_id")

  // Relations
  logs AgentLog[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([jobType])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@map("ai_jobs")
}

model AgentLog {
  id String @id @default(cuid())

  // Job reference
  jobId String? @map("job_id")
  job   AIJob?  @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Agent info
  agentName String    @map("agent_name")
  agentType AgentType @map("agent_type")

  // Log details
  action       String // thinking, executing, responding, error
  message      String @db.Text
  inputTokens  Int    @default(0) @map("input_tokens")
  outputTokens Int    @default(0) @map("output_tokens")

  // Model used
  modelName     String? @map("model_name")
  modelProvider String? @map("model_provider") // openai, anthropic, cloudflare

  // Timing
  durationMs Int? @map("duration_ms")

  // Data
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")

  @@index([jobId])
  @@index([agentName])
  @@index([agentType])
  @@index([createdAt])
  @@map("agent_logs")
}

model AgentMemory {
  id String @id @default(cuid())

  // Memory type
  memoryType MemoryType @map("memory_type")

  // Content
  content String  @db.Text
  summary String? @db.Text

  // Vector embedding (for semantic search)
  embedding      Bytes? // Store as binary for efficiency
  embeddingModel String? @map("embedding_model")

  // Context
  userId    String? @map("user_id")
  agentName String? @map("agent_name")
  jobId     String? @map("job_id")

  // Metadata
  tags           String[]  @default([])
  importance     Int       @default(5) // 1-10
  accessCount    Int       @default(0) @map("access_count")
  lastAccessedAt DateTime? @map("last_accessed_at")

  // Expiry
  expiresAt DateTime? @map("expires_at")

  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([memoryType])
  @@index([userId])
  @@index([agentName])
  @@index([tags])
  @@map("agent_memories")
}

enum AIJobStatus {
  PENDING
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  RETRY
}

enum AgentType {
  ORCHESTRATOR
  PLANNER
  SUPERVISOR
  CODE
  RESEARCH
  SEO
  BLOG
  BUSINESS
  RPA
  SECURITY
  REVIEWER
  RISK
  COMPLIANCE
}

enum MemoryType {
  CONVERSATION
  TASK_RESULT
  USER_PREFERENCE
  SYSTEM_KNOWLEDGE
  ERROR_PATTERN
  SUCCESS_PATTERN
}

// =============================================================================
// AUTOMATION & WEBHOOKS
// =============================================================================

model Automation {
  id String @id @default(cuid())

  // Automation info
  name        String
  description String? @db.Text

  // Trigger
  triggerType   TriggerType @map("trigger_type")
  triggerConfig Json        @map("trigger_config")

  // Actions
  actions Json // Array of action steps

  // Status
  isActive Boolean @default(true) @map("is_active")

  // User
  userId String @map("user_id")

  // Stats
  runCount      Int       @default(0) @map("run_count")
  lastRunAt     DateTime? @map("last_run_at")
  lastRunStatus String?   @map("last_run_status")

  // Relations
  runs AutomationRun[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([triggerType])
  @@index([isActive])
  @@map("automations")
}

model AutomationRun {
  id String @id @default(cuid())

  automationId String     @map("automation_id")
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  // Execution
  status      AutomationStatus @default(RUNNING)
  startedAt   DateTime         @default(now()) @map("started_at")
  completedAt DateTime?        @map("completed_at")

  // Results
  inputData    Json?   @map("input_data")
  outputData   Json?   @map("output_data")
  errorMessage String? @map("error_message") @db.Text

  // Steps
  stepsCompleted Int   @default(0) @map("steps_completed")
  totalSteps     Int   @default(0) @map("total_steps")
  stepLogs       Json? @map("step_logs")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([automationId])
  @@index([status])
  @@index([createdAt])
  @@map("automation_runs")
}

// Note: Webhook model already exists earlier in schema

model WebhookDelivery {
  id String @id @default(cuid())

  webhookId String @map("webhook_id")

  // Request
  eventType String @map("event_type")
  payload   Json

  // Response
  statusCode     Int?    @map("status_code")
  responseBody   String? @map("response_body") @db.Text
  responseTimeMs Int?    @map("response_time_ms")

  // Status
  success      Boolean @default(false)
  errorMessage String? @map("error_message")

  // Retry
  attempt     Int       @default(1)
  nextRetryAt DateTime? @map("next_retry_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([webhookId])
  @@index([eventType])
  @@index([success])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// Note: TriggerType enum already exists earlier in schema

enum AutomationStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// =============================================================================
// INTEGRATIONS
// =============================================================================

model Integration {
  id String @id @default(cuid())

  // Integration info
  name     String
  provider String // stripe, github, slack, etc.

  // Credentials (encrypted)
  accessToken    String?   @map("access_token")
  refreshToken   String?   @map("refresh_token")
  tokenExpiresAt DateTime? @map("token_expires_at")

  // Config
  config Json?
  scopes String[] @default([])

  // Status
  isActive   Boolean   @default(true) @map("is_active")
  lastSyncAt DateTime? @map("last_sync_at")
  lastError  String?   @map("last_error")

  // User
  userId String @map("user_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, provider])
  @@index([userId])
  @@index([provider])
  @@map("integrations")
}

// =============================================================================
// FILE STORAGE METADATA
// =============================================================================

model StorageFile {
  id String @id @default(cuid())

  // File info
  fileName     String @map("file_name")
  originalName String @map("original_name")
  mimeType     String @map("mime_type")
  size         Int // bytes

  // Storage
  bucket String // blog-images, user-avatars, etc.
  path   String // Full path in bucket
  url    String? // Public URL if applicable

  // User
  userId String? @map("user_id")

  // Metadata
  metadata Json?

  // Status
  isPublic Boolean @default(false) @map("is_public")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([bucket])
  @@index([mimeType])
  @@map("storage_files")
}
