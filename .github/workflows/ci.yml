name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run format:check

  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx tsc --noEmit

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: false
      - name: Configure Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Configure test database URL
        run: |
          db_url="${{ secrets.DATABASE_URL_TEST }}"
          if [ -z "$db_url" ]; then
            db_url="postgresql://test:test@localhost:5432/test"
          fi
          echo "DATABASE_URL=$db_url" >> $GITHUB_ENV
        shell: bash
      - run: npm run test -- --coverage --watchAll=false
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret
          JWT_SECRET: test-jwt-secret
          SESSION_SECRET: test-session-secret

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: false
      - name: Configure Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx playwright install --with-deps chromium
      - name: Configure E2E test environment
        id: set-env
        env:
          DB_SECRET: ${{ secrets.DATABASE_URL_TEST }}
          EMAIL_SECRET: ${{ secrets.TEST_USER_EMAIL }}
          PWD_SECRET: ${{ secrets.TEST_USER_PASSWORD }}
        run: |
          echo "DATABASE_URL=${DB_SECRET:-postgresql://test:test@localhost:5432/test}" >> $GITHUB_ENV
          [ -n "$EMAIL_SECRET" ] && echo "TEST_USER_EMAIL=$EMAIL_SECRET" >> $GITHUB_ENV || true
          [ -n "$PWD_SECRET" ] && echo "TEST_USER_PASSWORD=$PWD_SECRET" >> $GITHUB_ENV || true
        shell: bash
      - run: npm run test:e2e
        env:
          NODE_ENV: test
          NEXTAUTH_SECRET: test-secret
          JWT_SECRET: test-jwt-secret
          SESSION_SECRET: test-session-secret
      - uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  build:
    name: Build Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Configure Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx prisma generate
      - run: npm run build
      - name: Check build output
        run: test -d .next

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm audit --audit-level=moderate
      - run: npm run security:check || true
