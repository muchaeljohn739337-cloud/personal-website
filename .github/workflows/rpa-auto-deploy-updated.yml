name: Advancia RPA Auto Deploy & Self-Heal

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 */4 * * *" # Health check every 4 hours
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  issues: write

jobs:
  deploy:
    name: Build, Deploy & Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üß© Generate Prisma Client
        working-directory: ./backend
        run: npm run prisma:generate

      - name: üîç TypeScript Check - Backend
        working-directory: ./backend
        run: npx tsc --noEmit
        continue-on-error: true

      - name: üîç TypeScript Check - Frontend
        working-directory: ./frontend
        run: npx tsc --noEmit
        continue-on-error: true

      - name: üß± Build Backend
        working-directory: ./backend
        run: npm run build

      - name: üß± Build Frontend
        working-directory: ./frontend
        run: npm run build

      - name: üöÄ Trigger Render Deployment
        if: success()
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "üöÄ Triggering Render deployment..."
          DEPLOY_RESPONSE=$(curl -X POST \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}')

          DEPLOY_ID=$(echo $DEPLOY_RESPONSE | jq -r '.id')
          echo "‚úÖ Deploy triggered - ID: $DEPLOY_ID"
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_ENV

      - name: ‚è≥ Monitor Deployment
        if: success()
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "‚è≥ Monitoring deployment..."
          for i in {1..30}; do
            sleep 10
            STATUS=$(curl -s "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/${{ env.DEPLOY_ID }}" \
              -H "Authorization: Bearer $RENDER_API_KEY" | jq -r '.status')
            
            echo "[$i/30] Status: $STATUS"
            
            if [ "$STATUS" = "live" ]; then
              echo "üéâ Deployment succeeded!"
              exit 0
            elif [ "$STATUS" = "failed" ]; then
              echo "‚ùå Deployment failed"
              exit 1
            fi
          done

          echo "‚è±Ô∏è Monitoring timeout"
          exit 1

      - name: üè• Production Health Check
        if: success()
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL || 'https://api.advanciapayledger.com' }}
        run: |
          echo "üè• Checking production health..."
          sleep 30  # Wait for services to stabilize

          for i in {1..10}; do
            if curl -f -s "$BACKEND_URL/api/health" > /dev/null; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            fi
            echo "‚è≥ Waiting for backend... attempt $i/10"
            sleep 30
          done

          echo "‚ùå Backend health check failed"
          exit 1

      - name: üåê Purge Cloudflare Cache
        if: success()
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -z "$CLOUDFLARE_ZONE_ID" ] || [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "‚ö†Ô∏è Cloudflare credentials not set - skipping cache purge"
            exit 0
          fi

          echo "üåê Purging Cloudflare cache..."

          PURGE_RESPONSE=$(curl -X POST \
            "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"files": ["https://advanciapayledger.com/*", "https://api.advanciapayledger.com/*"]}')

          SUCCESS=$(echo $PURGE_RESPONSE | jq -r '.success')

          if [ "$SUCCESS" = "true" ]; then
            PURGE_ID=$(echo $PURGE_RESPONSE | jq -r '.result.id // "N/A"')
            echo "‚úÖ Cloudflare cache purged successfully"
            echo "   Purge ID: $PURGE_ID"
          else
            echo "‚ö†Ô∏è Cache purge failed:"
            echo $PURGE_RESPONSE | jq '.errors'
            exit 0  # Don't fail the whole deployment if cache purge fails
          fi

      - name: ‚úÖ Success Notification
        if: success()
        run: |
          echo "üéâ ================================"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "================================"
          echo "Backend: ${{ secrets.BACKEND_URL || 'https://api.advanciapayledger.com' }}"
          echo "Frontend: https://advanciapayledger.com"
          echo "CDN: Cache purged (Cloudflare)"
          echo "Time: $(date)"
          echo "Commit: ${{ github.sha }}"

      - name: üö® Failure - Create Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Deployment Failed - ${new Date().toISOString()}`;
            const body = `
            ## Deployment Failure Report

            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            **Commit:** ${context.sha.substring(0, 7)}
            **Branch:** ${context.ref}
            **Actor:** @${context.actor}

            ### Logs
            [View workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ### What to check
            - [ ] TypeScript compilation errors
            - [ ] Prisma migration status
            - [ ] Build errors in backend/frontend
            - [ ] Render deployment logs
            - [ ] Production health endpoint status
            - [ ] Environment variables (secrets)

            ### Auto-created by GitHub Actions
            This issue was automatically created because deployment failed.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'automated', 'urgent']
            });

      - name: üßπ Log Maintenance (Scheduled Only)
        if: github.event_name == 'schedule'
        run: |
          echo "üßπ Running log maintenance..."
          # This runs only on scheduled checks, not on every push
          echo "Log cleanup would run here (implementation in PowerShell script)"
