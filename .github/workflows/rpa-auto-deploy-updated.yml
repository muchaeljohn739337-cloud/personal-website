name: Advancia RPA Auto Deploy & Self-Heal

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 */4 * * *" # Health check every 4 hours
  workflow_dispatch: # Manual trigger

permissions:
  contents: read
  issues: write

jobs:
  deploy:
    name: Build, Deploy & Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üß© Generate Prisma Client
        run: npx prisma generate

      - name: üîç TypeScript Check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: üß± Build Application
        run: npm run build

      - name: üöÄ Deploy to Vercel (Self-Healing)
        if: success()
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: üè• Production Health Check & Self-Healing
        if: success()
        env:
          APP_URL: ${{ secrets.APP_URL || 'https://advanciapayledger.com' }}
        run: |
          echo "üè• Checking production health..."
          sleep 30  # Wait for services to stabilize

          HEALTHY=false
          for i in {1..10}; do
            if curl -f -s "$APP_URL/api/health" > /dev/null; then
              echo "‚úÖ Application is healthy!"
              HEALTHY=true
              break
            fi
            echo "‚è≥ Waiting for application... attempt $i/10"
            sleep 30
          done

          if [ "$HEALTHY" = "false" ]; then
            echo "‚ùå Health check failed - triggering self-healing..."
            echo "üîÑ Self-healing: Attempting to redeploy..."
            # Self-healing: Trigger Vercel redeploy if health check fails
            if [ -n "${{ secrets.VERCEL_TOKEN }}" ] && [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
              curl -X POST "https://api.vercel.com/v13/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}" \
                -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d '{"target": "production"}' || echo "‚ö†Ô∏è Self-healing redeploy failed"
            fi
            exit 1
          fi

      - name: üåê Purge Cloudflare Cache
        if: success()
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -z "$CLOUDFLARE_ZONE_ID" ] || [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "‚ö†Ô∏è Cloudflare credentials not set - skipping cache purge"
            exit 0
          fi

          echo "üåê Purging Cloudflare cache..."

          PURGE_RESPONSE=$(curl -X POST \
            "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"files": ["https://advanciapayledger.com/*", "https://api.advanciapayledger.com/*"]}')

          SUCCESS=$(echo $PURGE_RESPONSE | jq -r '.success')

          if [ "$SUCCESS" = "true" ]; then
            PURGE_ID=$(echo $PURGE_RESPONSE | jq -r '.result.id // "N/A"')
            echo "‚úÖ Cloudflare cache purged successfully"
            echo "   Purge ID: $PURGE_ID"
          else
            echo "‚ö†Ô∏è Cache purge failed:"
            echo $PURGE_RESPONSE | jq '.errors'
            exit 0  # Don't fail the whole deployment if cache purge fails
          fi

      - name: ‚úÖ Success Notification
        if: success()
        run: |
          echo "üéâ ================================"
          echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
          echo "================================"
          echo "Application: https://advanciapayledger.com"
          echo "API: https://advanciapayledger.com/api"
          echo "CDN: Cache purged (Cloudflare)"
          echo "Time: $(date)"
          echo "Commit: ${{ github.sha }}"

      - name: üö® Failure - Create Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Deployment Failed - ${new Date().toISOString()}`;
            const body = `
            ## Deployment Failure Report

            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            **Commit:** ${context.sha.substring(0, 7)}
            **Branch:** ${context.ref}
            **Actor:** @${context.actor}

            ### Logs
            [View workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ### What to check
            - [ ] TypeScript compilation errors
            - [ ] Prisma migration status
            - [ ] Build errors in backend/frontend
            - [ ] Render deployment logs
            - [ ] Production health endpoint status
            - [ ] Environment variables (secrets)

            ### Auto-created by GitHub Actions
            This issue was automatically created because deployment failed.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment', 'automated', 'urgent']
            });

      - name: üßπ Log Maintenance (Scheduled Only)
        if: github.event_name == 'schedule'
        run: |
          echo "üßπ Running log maintenance..."
          # This runs only on scheduled checks, not on every push
          echo "Log cleanup would run here (implementation in PowerShell script)"
