name: Production Health Monitor

on:
  schedule:
    # Run every 30 minutes
    - cron: "*/30 * * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell $($PSVersionTable.PSVersion) ready"

      - name: Run Production Monitoring
        shell: pwsh
        env:
          ADVANCIA_API_BEARER: ${{ secrets.ADVANCIA_API_BEARER }}
          ADVANCIA_API_KEY: ${{ secrets.ADVANCIA_API_KEY }}
        run: |
          $ErrorActionPreference = 'Continue'

          Write-Host "üöÄ Starting production health check..." -ForegroundColor Cyan

          # Run the monitoring script
          & ./scripts/monitor-production.ps1

          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Write-Host "‚úÖ Production health check passed" -ForegroundColor Green
          } else {
            Write-Host "‚ùå Production health check failed with exit code $exitCode" -ForegroundColor Red
            exit $exitCode
          }

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Production Health Check Failed',
              body: `Production monitoring detected issues at ${new Date().toISOString()}\n\nCheck the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`,
              labels: ['production', 'monitoring', 'urgent']
            });
            console.log(`Created issue #${issue.data.number}`);
