name: Deploy Backend to Render

on:
  push:
    branches: [main, staging]
    paths:
      - "backend/**"
      - "render.yaml"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  pre-deploy-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: ğŸ” TypeScript check
        working-directory: ./backend
        run: npx tsc --noEmit

      - name: ğŸ” Validate Prisma schema
        working-directory: ./backend
        run: npx prisma validate

      - name: ğŸ§ª Run tests
        working-directory: ./backend
        run: npm test
        env:
          NODE_ENV: test

  deploy:
    name: Deploy to Render
    needs: pre-deploy-checks
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Trigger Render deployment
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{}'

      - name: â³ Wait for deployment
        run: sleep 60

      - name: ğŸ¥ Health check
        run: |
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Health check attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            if curl -f -s "${{ secrets.BACKEND_URL }}/api/health" > /dev/null; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 10
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: ğŸ”” Notify on failure
        if: failure()
        run: |
          echo "Backend deployment failed!"
          echo "Check logs at: https://dashboard.render.com"

  post-deploy-verification:
    name: Post-Deployment Tests
    needs: deploy
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§ª Test critical endpoints
        run: |
          echo "Testing /api/health"
          curl -f "${{ secrets.BACKEND_URL }}/api/health"

          echo "Testing /api/system/status"
          curl -f "${{ secrets.BACKEND_URL }}/api/system/status" || echo "Status endpoint may require auth"

      - name: ğŸ“Š Report deployment
        run: |
          echo "âœ… Backend deployed successfully!"
          echo "Environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}"
          echo "URL: ${{ secrets.BACKEND_URL }}"
