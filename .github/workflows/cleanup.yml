name: Cleanup Failed Deployments

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup-old-artifacts:
    name: Clean Old Build Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v8
        with:
          script: |
            const days = 7;
            const timestamp = Date.now() - (days * 24 * 60 * 60 * 1000);
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            for (const artifact of artifacts.data.artifacts) {
              if (Date.parse(artifact.created_at) < timestamp) {
                console.log(`Deleting artifact: ${artifact.name}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }

  cleanup-old-workflow-runs:
    name: Clean Old Workflow Runs
    runs-on: ubuntu-latest
    
    steps:
      - name: Delete old workflow runs
        uses: actions/github-script@v8
        with:
          script: |
            const days = 30;
            const timestamp = Date.now() - (days * 24 * 60 * 60 * 1000);
            
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            for (const workflow of workflows.data.workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.id,
                status: 'completed',
              });
              
              for (const run of runs.data.workflow_runs) {
                if (Date.parse(run.created_at) < timestamp) {
                  console.log(`Deleting run: ${run.name} - ${run.id}`);
                  await github.rest.actions.deleteWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id,
                  });
                }
              }
            }
