name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to rollback"
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both
      reason:
        description: "Reason for rollback"
        required: true
        type: string

jobs:
  rollback:
    name: Rollback Service
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10

      - name: üîî Log rollback request
        run: |
          echo "============================================"
          echo "üö® EMERGENCY ROLLBACK INITIATED"
          echo "============================================"
          echo "Service: ${{ github.event.inputs.service }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Timestamp: $(date)"
          echo "============================================"

      - name: ‚èÆÔ∏è Rollback backend
        if: github.event.inputs.service == 'backend' || github.event.inputs.service == 'both'
        run: |
          echo "Rolling back backend on Render..."
          echo "‚ö†Ô∏è  Manual intervention required:"
          echo "1. Go to https://dashboard.render.com"
          echo "2. Navigate to advancia-backend service"
          echo "3. Click 'Manual Deploy' and select previous commit"
          echo "4. Or use Render API to trigger rollback"

      - name: ‚èÆÔ∏è Rollback frontend
        if: github.event.inputs.service == 'frontend' || github.event.inputs.service == 'both'
        run: |
          echo "Rolling back frontend on Vercel..."
          echo "‚ö†Ô∏è  Manual intervention required:"
          echo "1. Go to https://vercel.com/dashboard"
          echo "2. Navigate to advancia-frontend project"
          echo "3. Go to Deployments tab"
          echo "4. Find last stable deployment and click 'Promote to Production'"

      - name: üè• Verify services
        run: |
          echo "Waiting for rollback to complete..."
          sleep 60

          echo "Checking backend..."
          curl -f https://api.advanciapayledger.com/api/health || echo "Backend check failed"

          echo "Checking frontend..."
          curl -f https://advanciapayledger.com || echo "Frontend check failed"

      - name: üìä Rollback summary
        if: always()
        run: |
          echo "============================================"
          echo "ROLLBACK SUMMARY"
          echo "============================================"
          echo "Service: ${{ github.event.inputs.service }}"
          echo "Reason: ${{ github.event.inputs.reason }}"
          echo "Status: ${{ job.status }}"
          echo "Next steps:"
          echo "1. Verify services are functioning correctly"
          echo "2. Investigate root cause: ${{ github.event.inputs.reason }}"
          echo "3. Create incident report"
          echo "4. Plan fix and redeployment"
          echo "============================================"
