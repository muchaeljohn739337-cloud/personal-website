name: Full Stack Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Run All Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ğŸ“¦ Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: ğŸ§ª Run backend tests
        working-directory: ./backend
        run: npm test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db?schema=public

      - name: ğŸ“¦ Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ”¨ Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.advanciapayledger.com

  deploy-backend:
    name: Deploy Backend
    needs: test
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ğŸš€ Trigger Render deployment
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

      - name: â³ Wait for deployment
        run: sleep 90

      - name: ğŸ¥ Backend health check
        run: |
          for i in {1..10}; do
            if curl -f https://api.advanciapayledger.com/api/health; then
              echo "âœ… Backend healthy"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          exit 1

  deploy-frontend:
    name: Deploy Frontend
    needs: deploy-backend
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: ğŸ“¦ Install Vercel CLI
        run: npm install -g vercel@latest

      - name: ğŸš€ Deploy to Vercel
        working-directory: ./frontend
        run: vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  post-deploy-tests:
    name: Post-Deployment Verification
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§ª Test backend endpoints
        run: |
          echo "Testing backend health..."
          curl -f https://api.advanciapayledger.com/api/health

          echo "Testing system status..."
          curl -f https://api.advanciapayledger.com/api/system/status || echo "May require auth"

      - name: ğŸ§ª Test frontend
        run: |
          echo "Testing frontend..."
          curl -f https://advanciapayledger.com

      - name: ğŸ“Š Deployment summary
        run: |
          echo "âœ… Full stack deployment successful!"
          echo "Backend: https://api.advanciapayledger.com"
          echo "Frontend: https://advanciapayledger.com"
          echo "Deployed at: $(date)"

      - name: ğŸ”” Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment verification failed!"
          echo "Check logs and rollback if necessary"
