name: Finalize Advancia Platform Setup

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Root domain (e.g., advancia.app)"
        required: true
      backend_origin:
        description: "Backend origin URL (e.g., https://advancia-backend.onrender.com)"
        required: true

jobs:
  complete-setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Wrangler
        run: npm i -g wrangler@3

      - name: Export secret env vars
        run: |
          echo "RENDER_DEPLOY_HOOK_FRONTEND=${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}" >> $GITHUB_ENV
          echo "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" >> $GITHUB_ENV
          echo "CLOUDFLARE_ZONE_ID=${{ secrets.CLOUDFLARE_ZONE_ID }}" >> $GITHUB_ENV
          echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV

      # 1) Trigger Render Frontend Deploy via deploy hook (if secret set)
      - name: Deploy Frontend to Render
        run: |
          if [ -n "${RENDER_DEPLOY_HOOK_FRONTEND}" ]; then
            echo "ðŸš€ Triggering Render Frontend Deploy..."
            curl -fsSL -X POST "$RENDER_DEPLOY_HOOK_FRONTEND"
            echo "âœ… Render deploy hook triggered"
          else
            echo "â„¹ RENDER_DEPLOY_HOOK_FRONTEND not set; skipping Render deploy"
          fi

      # 2) Publish Cloudflare Worker using same structure as existing worker workflow
      - name: Build wrangler.toml from inputs
        working-directory: ./.infrastructure/cloudflare/workers
        run: |
          DOMAIN="${{ github.event.inputs.domain }}"
          test -n "$CLOUDFLARE_ACCOUNT_ID" || { echo "âŒ CLOUDFLARE_ACCOUNT_ID missing in secrets"; exit 1; }
          test -n "$CLOUDFLARE_ZONE_ID" || { echo "âŒ CLOUDFLARE_ZONE_ID missing in secrets"; exit 1; }
          cat > wrangler.toml <<EOF
          name = "advancia-api-gateway"
          main = "api-gateway.js"
          compatibility_date = "2024-10-01"
          account_id = "$CLOUDFLARE_ACCOUNT_ID"

          [vars]
          # BACKEND_ORIGIN is set at publish time via --var

          routes = [
            { pattern = "api.${DOMAIN}/*", zone_id = "$CLOUDFLARE_ZONE_ID" }
          ]
          EOF
          echo "âœ… wrangler.toml generated"

      - name: Publish Worker
        working-directory: ./.infrastructure/cloudflare/workers
        run: |
          BACKEND_ORIGIN="${{ github.event.inputs.backend_origin }}"
          test -n "$CLOUDFLARE_API_TOKEN" || { echo "âŒ CLOUDFLARE_API_TOKEN missing in secrets"; exit 1; }
          test -n "$BACKEND_ORIGIN" || { echo "âŒ backend_origin input missing"; exit 1; }
          echo "ðŸš€ Publishing Worker to Cloudflare..."
          wrangler publish --var BACKEND_ORIGIN="$BACKEND_ORIGIN" --minify
          echo "âœ… Worker published"

      # 3) Optional: Send notification to Discord if a webhook is configured
      - name: Send Deployment Notification
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            payload=$(jq -n \
              --arg content "âœ… Deployment Complete!\nðŸŒ Domain: https://api.${{ github.event.inputs.domain }}\nðŸš‰ Backend: ${{ github.event.inputs.backend_origin }}\nðŸ“¦ Render + Cloudflare in sync\nðŸ•’ $(date -u)" \
              '{username:"AdvanciaBot", content:$content}')
            curl -fsSL -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"
          else
            echo "â„¹ DISCORD_WEBHOOK_URL not set; skipping notification"
          fi

      - name: Summary
        run: |
          echo "### âœ… Finalize Advancia Platform Setup" >> $GITHUB_STEP_SUMMARY
          echo "- Domain: ${{ github.event.inputs.domain }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Origin: ${{ github.event.inputs.backend_origin }}" >> $GITHUB_STEP_SUMMARY
          echo "- Render Hook: ${RENDER_SET:-present}" >> $GITHUB_STEP_SUMMARY
        env:
          RENDER_SET: ${{ secrets.RENDER_DEPLOY_HOOK_FRONTEND }}
