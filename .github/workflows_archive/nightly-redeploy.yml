name: üîÅ Full Nightly Auto-Redeploy (Advancia)

on:
  schedule:
    # Runs daily at 3 AM UTC (10 PM EST / 7 PM PST)
    # Adjust schedule: https://crontab.guru
    - cron: "0 3 * * *"
  
  workflow_dispatch:  # Allow manual trigger from GitHub Actions tab
    inputs:
      deploy_backend:
        description: 'Deploy backend service'
        required: false
        default: 'true'
        type: boolean
      deploy_frontend:
        description: 'Deploy frontend service'
        required: false
        default: 'true'
        type: boolean

jobs:
  full-redeploy:
    name: Full Stack Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'- name: üîß Verify PowerShell
        shell: pwsh
        run: |
          Write-Host "‚úÖ PowerShell $($PSVersionTable.PSVersion) ready" -ForegroundColor Green
          Write-Host "üìç Working directory: $(Get-Location)" -ForegroundColor Cyan

      - name: üîê Create .env from GitHub Secrets
        run: |
          echo "# Auto-generated by GitHub Actions - $(date -u)" > .env
          echo "RENDER_API_KEY=${{ secrets.RENDER_API_KEY }}" >> .env
          echo "RENDER_SERVICE_ID=${{ secrets.RENDER_FRONTEND_SERVICE_ID || secrets.RENDER_SERVICE_ID }}" >> .env
          echo "RENDER_FRONTEND_SERVICE_ID=${{ secrets.RENDER_FRONTEND_SERVICE_ID }}" >> .env
          echo "RENDER_BACKEND_SERVICE_ID=${{ secrets.RENDER_BACKEND_SERVICE_ID }}" >> .env
          echo "CLOUDFLARE_API_TOKEN=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> .env
          echo "CLOUDFLARE_ZONE_ID=${{ secrets.CLOUDFLARE_ZONE_ID }}" >> .env
          echo "CLOUDFLARE_DOMAIN=advanciapayledger.com" >> .env
          echo "CI=true" >> .env
          echo "‚úÖ Environment configured with $( (Get-Content .env | Measure-Object -Line).Lines ) variables"
        shell: pwsh

      # === BACKEND DEPLOYMENT ===
      - name: üß± Backend Build & Deploy
        if: github.event.inputs.deploy_backend != 'false'
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "`nüî® Starting Backend Deployment..." -ForegroundColor Cyan
          
          if (Test-Path ./scripts/render-backend-auto.ps1) {
            pwsh ./scripts/render-backend-auto.ps1 2>&1 | Tee-Object -FilePath deploy-backend.log
            Write-Host "‚úÖ Backend deployment script completed" -ForegroundColor Green
          } else {
            Write-Host "‚ö† Backend deployment script not found, triggering via API..." -ForegroundColor Yellow
            
            $backendServiceId = $env:RENDER_BACKEND_SERVICE_ID
            $renderApiKey = $env:RENDER_API_KEY
            
            if ($backendServiceId -and $renderApiKey) {
              $headers = @{
                "Authorization" = "Bearer $renderApiKey"
                "Content-Type" = "application/json"
              }
              $url = "https://api.render.com/v1/services/$backendServiceId/deploys"
              
              try {
                $response = Invoke-RestMethod -Uri $url -Method Post -Headers $headers -Body "{}"
                Write-Host "‚úÖ Backend deployment triggered via API" -ForegroundColor Green
                "Backend deployment: Success - Deploy ID: $($response.id)" | Out-File -Append deploy-backend.log
              } catch {
                Write-Host "‚ùå Backend API deployment failed: $($_.Exception.Message)" -ForegroundColor Red
                "Backend deployment: Failed - $($_.Exception.Message)" | Out-File -Append deploy-backend.log
              }
            } else {
              Write-Host "‚è≠ Backend deployment skipped (credentials not configured)" -ForegroundColor Gray
              "Backend deployment: Skipped - No credentials" | Out-File deploy-backend.log
            }
          }

      # === FRONTEND DEPLOYMENT ===
      - name: üåê Frontend Build & Deploy + DNS Auto-Heal
        if: github.event.inputs.deploy_frontend != 'false'
        shell: pwsh
        run: |
          Write-Host "`nüî® Starting Frontend Deployment..." -ForegroundColor Cyan
          pwsh ./scripts/render-frontend-auto.ps1 2>&1 | Tee-Object -FilePath deploy-frontend.log
          Write-Host "‚úÖ Frontend deployment completed" -ForegroundColor Green

      # === VERIFICATION ===
      - name: üîç Verify Live Endpoints
        run: |
          echo "üåê Verifying deployment endpoints..." > deploy-checks.log
          echo "" >> deploy-checks.log
          
          # Wait for deployment propagation
          sleep 45
          
          # Check frontend
          echo "Checking frontend: https://advanciapayledger.com" >> deploy-checks.log
          FRONTEND_STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://advanciapayledger.com || echo "000")
          echo "  Status: HTTP $FRONTEND_STATUS" >> deploy-checks.log
          
          if [ "$FRONTEND_STATUS" == "200" ] || [ "$FRONTEND_STATUS" == "301" ] || [ "$FRONTEND_STATUS" == "302" ]; then
            echo "  ‚úÖ Frontend is live!" >> deploy-checks.log
          else
            echo "  ‚ö†Ô∏è Frontend returned unexpected status" >> deploy-checks.log
          fi
          
          # Check backend
          echo "" >> deploy-checks.log
          echo "Checking backend: https://api.advanciapayledger.com/health" >> deploy-checks.log
          BACKEND_STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://api.advanciapayledger.com/health || echo "000")
          echo "  Status: HTTP $BACKEND_STATUS" >> deploy-checks.log
          
          if [ "$BACKEND_STATUS" == "200" ]; then
            echo "  ‚úÖ Backend health check passed!" >> deploy-checks.log
          else
            echo "  ‚ö†Ô∏è Backend health check failed or not configured" >> deploy-checks.log
          fi
          
          # Display results
          cat deploy-checks.log

      # === ARTIFACTS ===
      - name: üì¶ Upload Deployment Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: advancia-deploy-logs-${{ github.run_number }}
          path: |
            deploy-backend.log
            deploy-frontend.log
            deploy-checks.log
          retention-days: 30

      # === NOTIFICATIONS ===
      - name: üì£ Slack Notification
        if: always() && secrets.SLACK_WEBHOOK != ''
        run: |
          STATUS="${{ job.status }}"
          ICON="‚úÖ"
          COLOR="#36a64f"
          
          if [ "$STATUS" != "success" ]; then
            ICON="‚ö†Ô∏è"
            COLOR="#ff9900"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$ICON Advancia Nightly Deployment\",
                \"text\": \"Status: $STATUS\",
                \"fields\": [
                  {\"title\": \"Trigger\", \"value\": \"${{ github.event_name }}\", \"short\": true},
                  {\"title\": \"Timestamp\", \"value\": \"$(date -u)\", \"short\": true}
                ],
                \"actions\": [
                  {\"type\": \"button\", \"text\": \"View Logs\", \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}
                ]
              }]
            }" \
            ${{ secrets.SLACK_WEBHOOK }} || echo "Slack notification failed"

      - name: üìß Email Notification
        if: always() && secrets.EMAIL_USERNAME != '' && secrets.EMAIL_PASSWORD != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "${{ job.status == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} Advancia Nightly Deploy - ${{ job.status }}"
          to: ${{ secrets.EMAIL_RECIPIENT || secrets.EMAIL_USERNAME }}
          from: "Advancia Deploy Bot <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            Deployment Report for advanciapayledger.com
            
            Status: ${{ job.status }}
            Trigger: ${{ github.event_name }}
            Timestamp: ${{ github.event.head_commit.timestamp }}
            Run ID: ${{ github.run_id }}
            
            Endpoints Checked:
            - Frontend: https://advanciapayledger.com
            - Backend: https://api.advanciapayledger.com/health
            
            View full logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          attachments: |
            deploy-backend.log
            deploy-frontend.log
            deploy-checks.log
          convert_markdown: true

      # === SUMMARY ===
      - name: üìä Deployment Summary
        if: always()
        run: |
          echo "## üöÄ Full Stack Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overall | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | $([ -f deploy-backend.log ] && echo '‚úÖ Deployed' || echo '‚è≠Ô∏è Skipped') |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | $([ -f deploy-frontend.log ] && echo '‚úÖ Deployed' || echo '‚è≠Ô∏è Skipped') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Live Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: [advanciapayledger.com](https://advanciapayledger.com)" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: [api.advanciapayledger.com](https://api.advanciapayledger.com/health)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Management Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Render Dashboard](https://dashboard.render.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloudflare Dashboard](https://dash.cloudflare.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Deployment Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

