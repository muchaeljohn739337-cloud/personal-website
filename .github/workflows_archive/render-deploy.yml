name: ğŸš€ Deploy Advancia Pay Ledger to Render

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deploy both services"
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Render

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ” Validate Render API Key
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          if [ -z "$RENDER_API_KEY" ]; then
            echo "âŒ Missing RENDER_API_KEY. Add it under GitHub Secrets"
            echo "Go to: Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi
          echo "âœ… Render API key detected"

      - name: ğŸ” Detect changes
        id: changes
        run: |
          BACKEND_CHANGED=false
          FRONTEND_CHANGED=false

          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "ğŸ”„ Force deploy requested"
            BACKEND_CHANGED=true
            FRONTEND_CHANGED=true
          else
            # Check for backend changes
            if git diff --name-only HEAD~1 HEAD | grep -q "^backend/\|^prisma/"; then
              BACKEND_CHANGED=true
              echo "ğŸ“¦ Backend changes detected"
            fi
            
            # Check for frontend changes
            if git diff --name-only HEAD~1 HEAD | grep -q "^frontend/"; then
              FRONTEND_CHANGED=true
              echo "ğŸ¨ Frontend changes detected"
            fi
          fi

          echo "backend_changed=$BACKEND_CHANGED" >> $GITHUB_OUTPUT
          echo "frontend_changed=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT

      - name: ğŸ”„ Deploy Backend
        if: steps.changes.outputs.backend_changed == 'true'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "ğŸ§± Triggering backend deployment..."

          # Using Render API to trigger deployment
          curl -X POST "https://api.render.com/v1/services/advancia-backend/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}' || {
              echo "âš ï¸ Backend deployment trigger failed (service may not exist yet)"
            }

      - name: ğŸ¨ Deploy Frontend
        if: steps.changes.outputs.frontend_changed == 'true'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        run: |
          echo "ğŸ¨ Triggering frontend deployment..."

          curl -X POST "https://api.render.com/v1/services/advancia-frontend/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}' || {
              echo "âš ï¸ Frontend deployment trigger failed (service may not exist yet)"
            }

      - name: ğŸ“¬ Notify on Slack (Optional)
        if: always() && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            EMOJI="âœ…"
            COLOR="good"
          else
            EMOJI="âŒ"
            COLOR="danger"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"$EMOJI Advancia Pay Ledger Deployment\",
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"fields\": [
                  {\"title\": \"Status\", \"value\": \"$STATUS\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": false}
                ]
              }]
            }" || echo "Slack notification skipped"

      - name: âœ… Deployment Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ ADVANCIA PAY LEDGER DEPLOYMENT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Backend deployed: ${{ steps.changes.outputs.backend_changed }}"
          echo "Frontend deployed: ${{ steps.changes.outputs.frontend_changed }}"
          echo "Status: ${{ job.status }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Access your deployment:"
          echo "  Frontend: https://advancia-frontend.onrender.com"
          echo "  Backend:  https://advancia-backend.onrender.com"
          echo "  Health:   https://advancia-backend.onrender.com/health"
