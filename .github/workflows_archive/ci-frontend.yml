name: ðŸŽ¨ Frontend CI (Optimized)

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - '.github/workflows/ci-frontend.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'frontend/**'

env:
  NODE_VERSION: '18'
  WORKING_DIR: 'frontend'

jobs:
  build-and-test:
    name: ðŸ—ï¸ Build & Test Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ” Lint
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run lint || echo "âš ï¸ Linting issues found but continuing..."
        continue-on-error: true

      - name: ðŸ“ TypeScript type check
        working-directory: ${{ env.WORKING_DIR }}
        run: npx tsc --noEmit

      - name: ðŸ—ï¸ Build Next.js
        working-directory: ${{ env.WORKING_DIR }}
        env:
          NEXT_PUBLIC_API_URL: https://api.advanciapayledger.com
          NEXT_PUBLIC_SOCKET_URL: https://api.advanciapayledger.com
          NODE_ENV: production
        run: npm run build

      - name: âœ… Verify standalone build
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          if [ -f .next/standalone/server.js ]; then
            echo "âœ… Standalone server.js exists"
            ls -lh .next/standalone/server.js
          else
            echo "âŒ ERROR: Standalone server.js not generated!"
            echo "Check that next.config.js has: output: 'standalone'"
            exit 1
          fi

      - name: ðŸ“Š Build summary
        run: |
          echo "## ðŸŽ¨ Frontend Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TypeScript type check passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Next.js build successful" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Standalone output verified" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: |
            frontend/.next/standalone
            frontend/.next/static
            frontend/public
          retention-days: 7

  docker-build-test:
    name: ðŸ³ Test Docker Build
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”¨ Build Docker image (test only)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: advancia-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… Docker build successful
        run: |
          echo "## ðŸ³ Docker Build Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Docker image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Image: advancia-frontend:test" >> $GITHUB_STEP_SUMMARY



